<link rel='import' href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<script src="bower_components/jsartoolkit5/build/artoolkit.debug.js"></script>
<script src="bower_components/jsartoolkit5/js/artoolkit.api.js"></script>
<script src="bower_components/three.js/build/three.min.js"></script>
<script src="bower_components/jsartoolkit5/js/artoolkit.three.js"></script>
<dom-module id="ar-component">
    <template>
        <style include="iron-flex iron-flex-alignment">
            :host {
                display: block;
            }
            div.display {
                display:flex;
                flex:1;
                width: 640px    !important;
                height: 480px;   !important;
                background:grey;
            }
        </style>
        <div class="display">
        </div>
    </template>
    <script>
        Polymer({
            is: 'ar-component',
            dumpScene: function(renderer) {
                function errorHandler(e) {
                    console.log(e);
                }
                function onInitFs(fs) {
                    var timestamp = new Date().getTime();
                    console.log(timestamp);
                    fs.root.getFile(`scene-${timestamp}.jpg`, {create: true}, function(fileEntry) {

                        // Create a FileWriter object for our FileEntry (log.txt).
                        fileEntry.createWriter(function(fileWriter) {

                            fileWriter.onwriteend = function(e) {
                                console.log('Write completed.');
                            };

                            fileWriter.onerror = function(e) {
                                console.log('Write failed: ' + e.toString());
                            };

                            // Create a new Blob and write it to log.txt.
                            data = renderer.domElement.toBlob(function(blob){
                                var newImg = document.createElement("img"),
                                        url = URL.createObjectURL(blob);
                                newImg.onload = function(){
                                    URL.revokeObjectURL(url);
                                };

                                newImg.src = url;
                                this.write(blob);
                                document.body.appendChild(newImg);
                            }.bind(this));
                            console.log(data.length);
                            console.log(data);



                        }, errorHandler);

                    }, errorHandler);

                }

                navigator.webkitPersistentStorage.requestQuota(1024 * 1024 * 200, function(grantedBytes) {
                    console.log(grantedBytes);
                }, function(e) { console.log(e)})
                window.webkitRequestFileSystem(window.PERSISTENT, 1024*1024, onInitFs, errorHandler);
            },
            onSuccess: function(arScene, arController, arCamera) {
                document.body.className = arController.orientation;
                console.log(this);
                var renderer = new THREE.WebGLRenderer({antialias: true, preserveDrawingBuffer: true});
                if (arController.orientation === 'portrait') {
                    var w = (window.innerWidth / arController.videoHeight) * arController.videoWidth;
                    var h = window.innerWidth;
                    renderer.setSize(w, h);
                    renderer.domElement.style.paddingBottom = (w-h) + 'px';
                } else {
                    if (/Android|mobile|iPad|iPhone/i.test(navigator.userAgent)) {
                        renderer.setSize(window.innerWidth, (window.innerWidth / arController.videoWidth) * arController.videoHeight);
                    } else {
                        renderer.setSize(arController.videoWidth, arController.videoHeight);
                        document.body.className += ' desktop';
                    }
                }
                this.$$('.display').appendChild(renderer.domElement);
                var rotationV = 0;
                var rotationTarget = 0;
                renderer.domElement.addEventListener('click', function(ev) {
                    ev.preventDefault();
                    rotationTarget += 1;
                }, false);
                var sphere = new THREE.Mesh(
                        new THREE.SphereGeometry(0.5, 8, 8),
                        new THREE.MeshNormalMaterial()
                );
                sphere.material.shading = THREE.FlatShading;
                sphere.position.z = 0.5;
                var torus = new THREE.Mesh(
                        new THREE.TorusGeometry(0.3, 0.2, 8, 8),
                        new THREE.MeshNormalMaterial()
                );
                torus.material.shading = THREE.FlatShading;
                torus.position.z = 0.5;
                torus.rotation.x = Math.PI/2;
                arController.loadMarker('data/patt.hiro', function(markerId) {
                    var markerRoot = arController.createThreeMarker(markerId);
                    markerRoot.add(sphere);
                    arScene.scene.add(markerRoot);
                });
                arController.loadMarker('data/patt.kanji', function(markerId) {
                    var markerRoot = arController.createThreeMarker(markerId);
                    markerRoot.add(torus);
                    arScene.scene.add(markerRoot);
                });
                this.dumpScene(renderer);
//                return;
                var tick = function() {
                    arScene.process();
                    rotationV += (rotationTarget - sphere.rotation.z) * 0.05;
                    sphere.rotation.z += rotationV;
                    torus.rotation.y += rotationV;
                    rotationV *= 0.8;
                    arScene.renderOn(renderer);
                    this.dumpScene(renderer);
                    requestAnimationFrame(tick);
                }.bind(this);
                tick();
            },
            attached: function() {

                x = ARController.getUserMediaThreeScene({cameraParam: 'data/camera_para-iPhone 5 rear 640x480 1.0m.dat', onSuccess: this.onSuccess.bind(this)});
                console.log(x);

            }
        });
    </script>
</dom-module>